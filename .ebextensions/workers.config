packages:
  yum:
    jq: []

files:
  "/etc/init/delayed_job.conf":
    content: |
      description "Start delayed_job worker"

      start on runlevel [2345]
      stop on runlevel [!2345]

      respawn

      cd /var/app/current
      exec bundle exec rake jobs:work

commands:
  00_parameters_cache:
    command: |
      /opt/aws/bin/cfn-get-metadata --region `{"Ref": "AWS::Region"}` --stack `{"Ref": "AWS::StackName"}` \
        --resource AWSEBBeanstalkMetadata --key AWS::ElasticBeanstalk::Ext |
        jq .Parameters > /etc/elasticbeanstalk/parameters-cache
  01_match_nginx_timeout_to_sqs_timeout:
    command: |
      VISIBILITY_TIMEOUT=$(jq -r .AWSEBVisibilityTimeout /etc/elasticbeanstalk/parameters-cache)
      if [[ "${VISIBILITY_TIMEOUT}" != "null" ]]; then
        echo "proxy_read_timeout ${VISIBILITY_TIMEOUT}s;" > /etc/nginx/conf.d/worker.conf
        service nginx restart
      fi
  02_ensure_webapp_home:
    command: |
      mkdir -p ~webapp

container_commands:
  00_start_worker:
    command: |
      if jq -r 'keys | .[]' /etc/elasticbeanstalk/parameters-cache | grep -q AWSEBWorkerQueueURL; then
        if status delayed_job | grep -q running; then
          restart delayed_job
        else
          start delayed_job
        fi
      fi
