
# imbrogno_export and the Query,imbrogno_export.sql, performs a filtered dump of the measurements table.
# Because of to much data, the request of certain Cities will timeout
# The Cities are: Uppsala, Honk Kong, Taipei, Amsterdam, Perth, Sydney, Honululu, Munich and Seoul
# This Query will export every dataset within a 3000m radius of the City center into a csv File

psql -U safecast --host $POSTGRESQL_ADDRESS safecast -f /var/deploy/api.safecast.org/web_head/current/script/imbrogno_export.sql
echo "ID,User ID,Captured Time,Latitude,Longitude,Value,Unit,Device ID" | cat - /tmp/imbrogno_export.csv > /var/deploy/api.safecast.org/web_head/shared/system/imbrogno_export-out.csv
cd /var/deploy/api.safecast.org/web_head/shared/system && tar -czf imbrogno_export-out.tar.gz imbrogno_export-out.csv
mv imbrogno_export-out.tar.gz imbrogno_export.tar.gz && mv imbrogno_export-out.csv imbrogno_export.csv

# rsync to the other server (this only runs on kangaroo)
rsync -Havq --bwlimit 10000 /var/deploy/api.safecast.org/web_head/shared/system/imbrogno_export.* reindeer.api.safecast.org.c66.me:/var/deploy/api.safecast.org/web_head/shared/system/
